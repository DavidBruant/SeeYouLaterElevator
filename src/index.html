<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="http://necolas.github.io/normalize.css/2.1.3/normalize.css">
    <link rel="stylesheet" type="text/css" href="https://rawgithub.com/marijnh/CodeMirror/master/lib/codemirror.css">
    <link rel="stylesheet" type="text/css" href="https://rawgithub.com/marijnh/CodeMirror/master/theme/solarized.css">
    <style>
        .column {
          display: inline-block;
          vertical-align: top;
          width: 45%;
        }

        .building{
            position: relative;
            left: 100px;
        }

        .building * {
          -webkit-box-sizing: border-box;
          -moz-box-sizing: border-box;
          box-sizing: border-box;
        }

        .shaft {
          display: inline-block;
          position: relative;
        }

        .floor, .elevator {
          margin: 5px 0;
        }

        .floor{
          background-color: #874;
          height: 100px;
          width: 100px;
        }
          .floor:before{
            content: attr(data-level);
          }

        .elevator{
            padding: 10px;
            position: absolute;
            bottom: 10px;
            left: 60px;
            width: 90px;
            height: 90px;
            background-color: #647;
            color: #DDD;

            transition-timing-function: ease;
            transition-property: bottom;
        }

        .elevator:nth-of-type(2){
            left: -60px;

        }


        #run-code{
            position: relative;
            top: 50px;
            width: 200px;
            height: 100px;
        }
    </style>
    <script src="https://rawgithub.com/Wolfy87/EventEmitter/master/EventEmitter.js"></script>
      
    <script>
    // https://github.com/cujojs/when#legacy-environments
    window.define = function(factory) {
        try{ delete window.define; } catch(e){ window.define = void 0; } // IE
        window.when = factory();
    };
    window.define.amd = {};
    </script>
    <script src="https://rawgithub.com/cujojs/when/master/when.js"></script>
      
    <script src="https://rawgithub.com/marijnh/CodeMirror/master/lib/codemirror.js"></script>
    <script src="https://rawgithub.com/marijnh/CodeMirror/master/mode/javascript/javascript.js"></script>
    
    <script>
      function Elevator(el){
          EventEmitter.call(this);

          // private
          this.el = el;
          this.currentFloor = 1;  // "first floor" as they say in English
          this.state = "ready";   // handling that as a state machine would be a great win
          this.latency = 0;

          this.requests = [];
      }

      Elevator.prototype = Object.create(EventEmitter.prototype);

      Elevator.prototype.goToFloor = function(n){
          var self = this;
          var def = when.defer();
          var b = parseInt(window.getComputedStyle(this.el).bottom);

          this.el.style.bottom = ((n-1)*105 + 10) + 'px'; // hardcoding :-( related to CSS height & margin
          this.el.style.transitionDuration = "1s"; // TODO make depend on floor difference

          this.state = "moving";
          this.el.setAttribute('data-at-floor', n);

          // Maybe listen to animationEnd? 
          setTimeout(function(){
              self.currentFloor = n;
              self.state = "ready";
              def.resolve();
          }, self.latency);

          return def.promise;
      }
      

      // on idle, if pending requests, pick on and act on it (or more complex logic)
      // emit 'floorRequest' events
      // emit an 'idle' event?
      // -> State Machine and transitioning states would address this questioning
      // -> Stacking calls would be good too. (FIFO processing)
    </script>

      <script>
      function floorRequestsScenario(e){
          // Floor requests scenario
          setTimeout(function(){ e.emit('floorRequest', 2); }, 500);
          setTimeout(function(){ e.emit('floorRequest', 3); }, 2000);
          setTimeout(function(){ e.emit('floorRequest', 4); }, 3500);
          setTimeout(function(){ e.emit('floorRequest', 1); }, 5000);
      }
      </script>
      
      <script>
          var elevators;
          
        (function(global){
              "use strict";
              
              document.addEventListener('DOMContentLoaded', function(){
                  elevators = Object.create(EventEmitter.prototype); // this is fucking dumb -_-$
                  EventEmitter.call(elevators);
                  
                  var els = [].slice.call(document.querySelectorAll('.shaft .elevator'))
                  els.forEach(function(el, i){ // this is a consequence of the fucking dumb thing above -_-$
                      elevators[i] = new Elevator(el);
                  });
                  elevators.length = els.length;
                  //Object.freeze(elevators);
              });
            
              global.runScenarios = function runScenarios(elevators){
                  // cleanup from previous runs
                  elevators.removeAllListeners('floorRequest');
                  
                  elevatorStrategy(elevators)
                  
                  floorRequestsScenario(elevators);
                  
                  if(typeof elevatorStrategy !== 'function')
                      throw new Error('An "elevatorStrategy" function must be defined somewhere');
                  
              };
        
        })(this);
      </script>
      
<!--
Need to listen to floorRequests (indifferenciated of whether it comes from the inside or outside)
-->
<script id="evaluated-scripts">
function elevatorStrategy (elevators) {

    elevators.on('floorRequest', function (floor) {
        elevators[ Math.random() < 0.5 ? 0 : 1].goToFloor(floor);
    });

}
</script>

    <title> See you later elevator </title>
  </head>

  <body>
      <div class="building column">
        <dl class="shaft">
          <dt class="elevator" data-at-floor="1">Elevator</dt>
          <dd class="floor" data-level="4"></dd>
          <dd class="floor" data-level="3"></dd>
          <dd class="floor" data-level="2"></dd>
          <dd class="floor" data-level="1"></dd>
        </dl>
        <dl class="shaft">
          <dt class="elevator" data-at-floor="1">Elevator</dt>
          <dd class="floor" data-level="4"></dd>
          <dd class="floor" data-level="3"></dd>
          <dd class="floor" data-level="2"></dd>
          <dd class="floor" data-level="1"></dd>
        </dl>
        <dl class="shaft">
          <dt class="elevator" data-at-floor="1">Elevator</dt>
          <dd class="floor" data-level="4"></dd>
          <dd class="floor" data-level="3"></dd>
          <dd class="floor" data-level="2"></dd>
          <dd class="floor" data-level="1"></dd>
        </dl>
        <dl class="shaft">
          <dt class="elevator" data-at-floor="1">Elevator</dt>
          <dd class="floor" data-level="4"></dd>
          <dd class="floor" data-level="3"></dd>
          <dd class="floor" data-level="2"></dd>
          <dd class="floor" data-level="1"></dd>
        </dl>
      </div>
      
      <div class="column">
        <textarea id="editor" cols="30" rows="10"></textarea>
      
        <button id="run-code">Run Code</button>
      </div>
      
      

      <script type="text/javascript"> // CodeMirror
        (function(d){
          var editor = d.getElementById('editor');
          editor.innerHTML = d.getElementById('evaluated-scripts').innerHTML;

          var strategyEditor = CodeMirror.fromTextArea(editor, {
            mode: {name: "javascript", json: true},
            lineNumbers: true,
            autofocus: true,
            theme: "solarized dark"
          });

          strategyEditor.setSize('100%', '100%');

          d.getElementById('run-code').addEventListener('click', function(){
              eval(strategyEditor.getValue());
              runScenarios(elevators);
          });
        })(document);
      </script>
  </body>
</html>
